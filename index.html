<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Transaksi Stokis GMRJ</title>
    <style>
        :root {
            /* Palet Warna Hijau Profesional */
            --color-primary: #065f46; 
            --color-primary-dark: #064e3b;
            --color-primary-light: #10b981;
            --color-secondary: #d1fae5; 
            --color-bg: #f0fdf4; 
            --color-surface: #ffffff;
            --color-text: #1f2937;
            --color-text-light: #6b7280;
            --color-border: #e5e7eb;
            --color-success: #059669;
            --color-warning: #d97706;
            --color-error: #dc2626;
            
            /* Spacing & Layout */
            --spacing-4: 4px;
            --spacing-8: 8px;
            --spacing-12: 12px;
            --spacing-16: 16px;
            --spacing-24: 24px;
            --radius: 12px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            display: none; 
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(180deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
            color: white;
            padding: var(--spacing-24);
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: 100vh;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: var(--spacing-24);
            padding-bottom: var(--spacing-16);
            border-bottom: 1px solid rgba(255,255,255,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            letter-spacing: -0.5px;
        }

        .close-sidebar-btn {
            background: none; border: none; color: rgba(255,255,255,0.8);
            font-size: 24px; cursor: pointer; display: none; transition: color 0.2s;
        }
        .close-sidebar-btn:hover { color: white; }

        .nav-menu { list-style: none; display: flex; flex-direction: column; gap: 4px; }
        .nav-menu button {
            width: 100%; padding: var(--spacing-12) var(--spacing-16);
            background: none; border: none; color: rgba(255,255,255,0.8);
            cursor: pointer; text-align: left; border-radius: var(--radius);
            transition: all 0.2s; font-size: 14px; font-weight: 500;
            display: flex; align-items: center; gap: 10px;
        }
        .nav-menu button:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-menu button.active { background: var(--color-surface); color: var(--color-primary); font-weight: 700; box-shadow: var(--shadow-md); }

        .main-content { padding: var(--spacing-24); overflow-y: auto; width: 100%; }
        
        .mobile-menu-btn {
            display: none; background: none; border: none; font-size: 28px;
            color: var(--color-primary); cursor: pointer; margin-right: var(--spacing-8);
        }

        .header { margin-bottom: var(--spacing-32); display: flex; flex-direction: column; }
        .header-top { display: flex; align-items: center; }
        .header h1 { font-size: 32px; font-weight: 800; color: var(--color-primary-dark); margin-bottom: 4px; letter-spacing: -1px; }
        .header p { color: var(--color-text-light); font-size: 16px; }

        /* Cards */
        .card {
            background: var(--color-surface);
            border-radius: var(--radius);
            padding: var(--spacing-24);
            margin-bottom: var(--spacing-24);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.3s ease;
        }
        .card:hover { box-shadow: var(--shadow-md); }
        .card h3 { margin-bottom: var(--spacing-20); color: var(--color-text); font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--spacing-24); margin-bottom: var(--spacing-32); }
        .stat-box {
            background: var(--color-surface); padding: var(--spacing-24); border-radius: var(--radius);
            border: 1px solid var(--color-border); box-shadow: var(--shadow-sm);
            border-left: 5px solid var(--color-primary);
        }
        .stat-label { color: var(--color-text-light); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--spacing-8); }
        .stat-value { font-size: 32px; font-weight: 800; color: var(--color-primary-dark); }

        /* Tables */
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--color-border); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: fixed; } 
        th { 
            background: #f8fafc; padding: var(--spacing-12) var(--spacing-16); text-align: left; 
            font-weight: 700; color: var(--color-text); border-bottom: 2px solid var(--color-border); 
            white-space: nowrap; 
        }
        td { padding: var(--spacing-12) var(--spacing-16); border-bottom: 1px solid var(--color-border); vertical-align: middle; }
        tbody tr:nth-child(even) { background-color: #fafbfc; }
        tbody tr:hover { background-color: #f3f4f6; transition: background 0.2s; }
        
        th.text-right, td.text-right { text-align: right; }
        td.font-mono { font-family: 'Courier New', Courier, monospace; letter-spacing: -0.5px; }

        /* Total Row Style (Footer) */
        tbody tr.total-row, tfoot tr { 
            background: var(--color-primary) !important; color: white !important; 
            font-weight: 700; border-top: 2px solid rgba(255,255,255,0.3) !important; 
        }
        tbody tr.total-row td, tfoot tr td { border-bottom: none !important; padding: 16px; color: white; }

        /* Forms & Inputs */
        .form-group { margin-bottom: var(--spacing-20); }
        label { display: block; margin-bottom: var(--spacing-8); font-weight: 600; color: var(--color-text); font-size: 14px; }
        input, select, textarea {
            width: 100%; padding: 10px 12px;
            border: 1px solid #d1d5db; border-radius: 8px;
            font-size: 14px; color: var(--color-text);
            transition: all 0.2s; background: white;
        }
        table input[type="number"] {
            padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px;
            width: 90px; text-align: right; font-weight: 600;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(6, 95, 70, 0.1); 
        }
        input:disabled { background-color: #f3f4f6; cursor: not-allowed; color: #9ca3af; }

        /* Buttons */
        .btn {
            padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 600; font-size: 14px; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 8px; justify-content: center;
        }
        .btn-primary { background: var(--color-primary); color: white; box-shadow: var(--shadow-sm); }
        .btn-primary:hover { background: var(--color-primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-secondary { background: white; border: 1px solid #d1d5db; color: var(--color-text); }
        .btn-secondary:hover { background: #f9fafb; border-color: #9ca3af; }
        .btn-danger { background: #fef2f2; color: var(--color-error); border: 1px solid #fecaca; }
        .btn-danger:hover { background: #fee2e2; border-color: #fca5a5; }
        .btn-success { background: #ecfdf5; color: var(--color-success); border: 1px solid #a7f3d0; }
        .btn-success:hover { background: #d1fae5; border-color: #6ee7b7; }
        .btn-small { padding: 6px 10px; font-size: 12px; border-radius: 6px; }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            align-items: center; justify-content: center; z-index: 2000; 
            animation: fadeIn 0.2s ease-out;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--color-surface); padding: var(--spacing-24); border-radius: var(--radius);
            width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto;
            box-shadow: var(--shadow-lg); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: var(--spacing-20); padding-bottom: var(--spacing-16);
            border-bottom: 1px solid var(--color-border);
        }
        .modal-header h2 { font-size: 20px; font-weight: 700; color: var(--color-primary-dark); }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-light); transition: color 0.2s; }
        .close-btn:hover { color: var(--color-error); }

        /* Affiliate Integration CSS */
        .level-0 { color: #c0152f; font-weight: 700; }
        .level-1 { color: #e6814d; font-weight: 600; }
        .level-2 { color: #208090; font-weight: 600; }
        .level-3 { color: #2d7ab6; font-weight: 600; }
        .level-4 { color: #6b21a8; font-weight: 600; }
        .level-5 { color: #059669; font-weight: 600; }

        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-success { background: rgba(5, 150, 105, 0.2); color: #059669; border: 1px solid #a7f3d0; }
        .badge-inactive { background: #e5e7eb; color: #6b7280; border: 1px solid #e5e7eb; }
        .badge-blue { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-16); }
        .summary-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-16); margin-bottom: var(--spacing-24); }
        .summary-item { background: #f9f9f9; padding: var(--spacing-16); border-radius: var(--radius); border: 1px solid var(--color-border); }
        .summary-item-label { font-size: 12px; color: var(--color-text-light); margin-bottom: var(--spacing-8); }
        .summary-item-value { font-size: 18px; font-weight: 700; color: var(--color-primary); }

        .report-accordion {
            margin-bottom: var(--spacing-24); border: 1px solid var(--color-border);
            border-radius: var(--radius); background: var(--color-surface);
            box-shadow: var(--shadow-sm); overflow: hidden;
        }
        .report-header {
            display: flex; justify-content: space-between; align-items: center; 
            padding: var(--spacing-16) var(--spacing-24); background: #f8fafc;
            cursor: pointer; user-select: none; transition: background 0.2s;
            flex-wrap: nowrap; 
        }
        .report-header:hover { background: #f1f5f9; }
        .report-header h3 { margin: 0; font-size: 16px; color: var(--color-text); display: flex; align-items: center; gap: var(--spacing-8); font-weight: 600; }
        .report-header h3::before {
            content: '+'; display: inline-block; font-size: 20px; font-weight: 700; 
            color: var(--color-primary); transition: transform 0.3s; width: 20px; text-align: center;
        }
        .report-accordion.active .report-header h3::before { transform: rotate(45deg); }
        .report-body { display: none; padding: var(--spacing-24); border-top: 1px solid var(--color-border); }
        .report-accordion.active .report-body { display: block; animation: slideDown 0.3s ease-out; }

        /* Toolbar Cetak & Export */
        .page-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: var(--spacing-24);
        }
        .toolbar-actions { display: flex; gap: var(--spacing-8); }

        /* PERBAIKAN TABEL LAPORAN AGAR LURUS & TEPAT */
        #report-table { table-layout: fixed; width: 100%; }
        /* 
           Total lebar harus 100% agar lurus sempurna.
           1. Produk (35%)
           2. Poin Patokan (10%)
           3. Jml Beli (13.75%)
           4. Tot. Poin Beli (13.75%)
           5. Jml Jual (13.75%)
           6. Tot. Poin Jual (13.75%)
        */
        #report-table th:nth-child(1) { width: 35%; text-align: left; } 
        #report-table th:nth-child(2) { width: 10%; text-align: center; }
        #report-table th:nth-child(3) { width: 13.75%; text-align: right; }
        #report-table th:nth-child(4) { width: 13.75%; text-align: right; }
        #report-table th:nth-child(5) { width: 13.75%; text-align: right; }
        #report-table th:nth-child(6) { width: 13.75%; text-align: right; }

        /* Footer alignment override to match columns */
        #report-table tfoot td { text-align: right; }
        #report-table tfoot td:first-child { text-align: left; }

        /* Network Tree */
        .member-node-card {
            background: white; border: 1px solid var(--color-border); border-radius: var(--radius);
            padding: var(--spacing-12) var(--spacing-16); display: inline-block; min-width: 220px; 
            box-shadow: var(--shadow-sm); transition: all 0.3s; text-align: left; position: relative; z-index: 2;
            white-space: normal;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Print - PERBAIKAN LOGIKA PEMISAHAN HALAMAN */
        @media print {
            /* Sembunyikan UI & Sidebar */
            .sidebar, .header, .mobile-menu-btn, .nav-menu, .settings, 
            .report-header, .modal, .form-group, .page-toolbar, .btn { display: none !important; }
            
            /* Reset Body Layout */
            body, .container, .main-content {
                height: auto !important; overflow: visible !important;
                display: block !important; padding: 0 !important; margin: 0 !important;
                position: static !important; background: white !important; color: black !important;
            }

            /* Default: Sembunyikan Semua Tab */
            .tab-content { display: none !important; }

            /* 1. LOGIKA CETAK TRANSAKSI (Hanya Transaksi) */
            body.printing-transactions #transactions { display: block !important; } 
            body.printing-transactions .card { border: none !important; box-shadow: none !important; padding: 0 !important; }
            body.printing-transactions #transactions-table { font-size: 10pt; width: 100%; border-collapse: collapse; }
            body.printing-transactions #transactions-table th, body.printing-transactions #transactions-table td { border: 1px solid #000; padding: 4px; color: black; background: white !important; }

            /* 2. LOGIKA CETAK POIN MEMBER (Hanya Points) */
            body.printing-points #points { display: block !important; }
            body.printing-points .card { border: none !important; box-shadow: none !important; padding: 0 !important; }
            body.printing-points #points-table { font-size: 10pt; width: 100%; border-collapse: collapse; }
            body.printing-points #points-table th, body.printing-points #points-table td { border: 1px solid #000; padding: 4px; color: black; background: white !important; }

            /* 3. LOGIKA CETAK LAPORAN (Reports) */
            #reports { display: block !important; } 
            .report-accordion { border: none !important; box-shadow: none !important; margin-bottom: 0 !important; }
            .report-body { display: none !important; border: none !important; padding: 0 !important; }
            .report-accordion.active .report-body { display: block !important; }
            #report-table { font-size: 10pt; width: 100%; border-collapse: collapse; }
            #report-table th, #report-table td { border: 1px solid #000; padding: 4px; color: black; }
        }

        /* Network Tree CSS */
        .tree-container { display: flex; justify-content: center; padding: var(--spacing-24); overflow-x: auto; min-height: 200px; }
        .tree ul { padding-top: 20px; position: relative; transition: all 0.5s; list-style-type: none; padding-left: 20px; display: flex; justify-content: center; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; transition: all 0.5s; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid var(--color-primary); width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 1px solid var(--color-primary); }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before{ border-right: 1px solid var(--color-primary); border-radius: 0 5px 0 0; }
        .tree li:first-child::after{ border-radius: 5px 0 0 0; }
        .tree ul ul::before{ content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid var(--color-primary); width: 0; height: 20px; }
        
        .node-header { display: flex; align-items: center; gap: var(--spacing-8); margin-bottom: var(--spacing-4); }
        .node-id { font-size: 10px; font-weight: 700; color: var(--color-secondary); background: #f0f0f0; padding: 2px 6px; border-radius: 4px; }
        .node-name { font-weight: 600; color: var(--color-text); font-size: 14px; }
        .node-stats { display: flex; justify-content: space-between; font-size: 11px; color: var(--color-text-light); border-top: 1px solid #f3f4f6; padding-top: 8px; }
        .node-stat span { display: block; }
        .node-stat .val { font-weight: 600; color: var(--color-primary); }
        .btn-expand { background: #e0f2fe; color: #0369a1; border: none; padding: 4px 8px; border-radius: 12px; font-size: 11px; cursor: pointer; margin-top: var(--spacing-8); width: 100%; display: none; text-align: center; font-weight: 600; }
        .btn-expand:hover { background: #bae6fd; }

        /* Login */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-card {
            background: white; padding: 48px; border-radius: 16px;
            box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; text-align: center;
        }
        .login-card h2 { margin-bottom: var(--spacing-24); color: var(--color-primary-dark); font-size: 24px; }
        .login-card input { margin-bottom: var(--spacing-16); padding: 12px; }
        .login-btn { width: 100%; padding: 14px; font-size: 16px; letter-spacing: 0.5px; }

        /* Mobile */
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; transform: translateX(-100%); box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
            .sidebar.active { transform: translateX(0); }
            .close-sidebar-btn { display: block; } 
            .mobile-menu-btn { display: block; } 
            .main-content { padding: var(--spacing-16); }
            .form-row { grid-template-columns: 1fr; }
            .header h1 { font-size: 24px; }
            .card { padding: var(--spacing-16); }
            .page-toolbar { flex-direction: column; gap: 10px; align-items: flex-start; }
            .btn { width: 100%; justify-content: center; }
            .stats-grid { grid-template-columns: 1fr; gap: var(--spacing-12); }
            .stat-value { font-size: 20px; }
            .tree li { float: none; padding-left: 0; padding-right: 0; padding-bottom: 30px; display: block; }
            .tree li::before, .tree li::after { display: none; } 
            .tree ul ul::before { display: none; }
            .member-node-card { width: 100%; display: flex; align-items: center; justify-content: space-between; }
            .tree ul { padding-left: 20px; display: block; }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-card">
            <h2>üîê Login Sistem Stokis</h2>
            <form onsubmit="checkLogin(event)">
                <div class="form-group" style="text-align: left;">
                    <label>Username</label>
                    <input type="text" id="loginUsername" required placeholder="Masukkan Username">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required placeholder="Masukkan Password">
                </div>
                <button type="submit" class="btn btn-primary login-btn">Masuk Aplikasi</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar no-print" id="sidebar">
            <div class="sidebar-title">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <span style="font-weight: 700; font-size: 20px; line-height: 1;">Stokis GMRJ</span>
                </div>
                <button class="close-sidebar-btn" onclick="toggleSidebar()">&times;</button>
            </div>
            <ul class="nav-menu">
                <li><button class="nav-btn active" data-tab="dashboard" onclick="closeSidebarMobile()">üìä Dashboard</button></li>
                <li><button class="nav-btn" data-tab="products" onclick="closeSidebarMobile()">üì¶ Produk</button></li>
                <li><button class="nav-btn" data-tab="members" onclick="closeSidebarMobile()">üë• Member</button></li>
                <li><button class="nav-btn" data-tab="transactions" onclick="closeSidebarMobile()">üìà Transaksi</button></li>
                <li><button class="nav-btn" data-tab="points" onclick="closeSidebarMobile()">üìä Poin Member</button></li>
                <li><button class="nav-btn" data-tab="reports" onclick="closeSidebarMobile()">üìã Laporan</button></li>
                <li><button class="nav-btn" data-tab="settings" onclick="closeSidebarMobile()">‚öôÔ∏è Pengaturan</button></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="header-top">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                    <div>
                        <h1>Data Transaksi Stokis</h1>
                        <p>Dashboard Manajemen Stokis</p>
                    </div>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Total Member</div>
                        <div class="stat-value" id="total-members">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Produk</div>
                        <div class="stat-value" id="total-products">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Transaksi</div>
                        <div class="stat-value" id="total-transactions">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Poin</div>
                        <div class="stat-value" id="total-points">0</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Transaksi Penjualan Terbaru</h3>
                    <div class="table-wrapper">
                        <table id="recent-transactions">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Member</th>
                                    <th>Produk</th>
                                    <th class="text-right">Jumlah</th>
                                    <th class="text-right">Total Poin</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" style="text-align: center; color: #9ca3af; padding: 24px;">Belum ada data</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Produk -->
            <div id="products" class="tab-content" style="display: none;"> 
                <div class="card">
                    <div class="page-toolbar">
                        <h3 style="margin: 0;">Daftar Produk</h3>
                        <button class="btn btn-primary" onclick="openAddProductModal()">+ Tambah Produk</button>
                    </div>
                    <div class="table-wrapper">
                        <table id="products-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Nama Produk</th>
                                    <th style="width: 15%;">Poin/Satuan</th>
                                    <th style="width: 20%;">Pembelian (Stok)</th>
                                    <th style="width: 15%;" class="text-right">Total Poin</th>
                                    <th style="width: 10%;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Member -->
            <div id="members" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="page-toolbar">
                        <h3 style="margin: 0;">Daftar Member</h3>
                        <button class="btn btn-primary" onclick="openAddMemberModal()">+ Tambah Member</button>
                    </div>
                    <div class="table-wrapper">
                        <table id="members-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nama</th>
                                    <th>Upline</th>
                                    <th>Koordinat</th>
                                    <th class="text-right">Total Poin</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Transaksi -->
            <div id="transactions" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="page-toolbar">
                        <h3 style="margin: 0;">Input Penjualan ke Member</h3>
                        <div class="toolbar-actions">
                            <button class="btn btn-primary" onclick="openAddTransactionModal()">+ Penjualan Baru</button>
                        </div>
                    </div>
                    
                    <!-- TOOLBAR CETAK & EKSPOR (TERPISAH) -->
                    <div class="page-toolbar no-print" style="margin-bottom: 0; padding-bottom: var(--spacing-24); border-bottom: 1px dashed var(--color-border);">
                        <span style="font-size: 14px; font-weight: 600; color: var(--color-text);">Opsi Laporan:</span>
                        <div class="toolbar-actions">
                            <button class="btn btn-secondary" onclick="printPage('transactions')">üñ®Ô∏è Cetak PDF</button>
                            <button class="btn btn-success" onclick="exportTransactionsToExcel()">üìä Export Excel</button>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table id="transactions-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Tanggal</th>
                                    <th>Member</th>
                                    <th>Produk</th>
                                    <th class="text-right">Jml Jual</th>
                                    <th class="text-right">Total Poin</th>
                                    <th class="no-print">Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB POIN MEMBER -->
            <div id="points" class="tab-content" style="display: none;">
                <div class="card">
                    <h3>üìä Distribusi Poin Per Member (Skema Affiliate)</h3>
                    <p style="margin-bottom: var(--spacing-16); color: var(--color-text-light); font-size: 14px;">
                        Halaman ini menghitung distribusi poin affiliate secara otomatis dari data transaksi.
                    </p>

                    <!-- TOOLBAR CETAK & EKSPOR (TERPISAH) -->
                    <div class="page-toolbar no-print" style="margin-bottom: 0; padding-bottom: var(--spacing-24); border-bottom: 1px dashed var(--color-border);">
                        <span style="font-size: 14px; font-weight: 600; color: var(--color-text);">Opsi Laporan:</span>
                        <div class="toolbar-actions">
                            <button class="btn btn-secondary" onclick="printPage('points')">üñ®Ô∏è Cetak PDF</button>
                            <button class="btn btn-success" onclick="exportPointsToExcel()">üìä Export Excel</button>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table id="points-table">
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Poin Level 0</th>
                                    <th>Poin Level 1</th>
                                    <th>Poin Level 2</th>
                                    <th>Poin Level 3</th>
                                    <th>Poin Level 4</th>
                                    <th>Poin Level 5</th>
                                    <th class="text-right">Total Poin</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Laporan -->
            <div id="reports" class="tab-content" style="display: none;">
                <h2 style="margin-bottom: var(--spacing-24);">Laporan & Analisis</h2>

                <div class="report-accordion active" id="acc-overview">
                    <div class="report-header" onclick="toggleReportSection('overview')">
                        <h3>üìä Ringkasan (Beli vs Jual)</h3>
                        <button class="btn btn-secondary no-print" onclick="event.stopPropagation(); printReport()">üñ®Ô∏è Cetak Laporan</button>
                    </div>
                    <div id="overview" class="report-body">
                        <div class="table-wrapper">
                            <table id="report-table">
                                <thead>
                                    <tr>
                                        <th style="width: 35%;">Produk</th>
                                        <th style="width: 10%;">Poin Patokan</th>
                                        <th style="width: 13.75%;" class="text-right">Jml Beli (Stok)</th>
                                        <th style="width: 13.75%;" class="text-right">Tot. Poin Beli</th>
                                        <th style="width: 13.75%;" class="text-right">Jml Jual (Keluar)</th>
                                        <th style="width: 13.75%;" class="text-right">Tot. Poin Jual</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2"><strong>AKUMULASI</strong></td>
                                        <td colspan="1" class="text-right"><strong id="report-sum-beli">0</strong></td>
                                        <td colspan="1" class="text-right"><strong id="report-sum-point-beli">0.00</strong></td>
                                        <td colspan="1" class="text-right"><strong id="report-sum-jual">0</strong></td>
                                        <td colspan="1" class="text-right"><strong id="report-sum-point-jual">0.00</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="report-accordion" id="acc-ranking">
                    <div class="report-header" onclick="toggleReportSection('ranking')">
                        <h3>üèÜ Ranking Poin</h3>
                        <button class="btn btn-secondary no-print" onclick="event.stopPropagation(); printReport()">üñ®Ô∏è Cetak Laporan</button>
                    </div>
                    <div id="ranking" class="report-body">
                        <div class="table-wrapper">
                            <table id="ranking-table">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">Ranking</th>
                                        <th style="text-align: center;">ID Member</th>
                                        <th>Nama Member</th>
                                        <th style="width: 140px;">Total Poin</th>
                                        <th>Upline</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pengaturan -->
            <div id="settings" class="tab-content" style="display: none;">
                <div class="card">
                    <h3>‚öôÔ∏è Pengaturan & Data</h3>
                    <div class="backup-section" style="display: grid; gap: var(--spacing-16); padding: var(--spacing-20); background: #f0fdf4; border-radius: var(--radius); border: 1px dashed var(--color-primary);">
                        <div>
                            <h4>üì§ Export Data Member (CSV)</h4>
                            <p style="font-size: 13px; color: var(--color-text-light); margin-bottom: var(--spacing-8);">Download data member ke file CSV.</p>
                            <button class="btn btn-success" onclick="exportMembersToCSV()">üì• Export Data Member</button>
                        </div>
                        <hr style="border: 0; border-top: 1px solid #d1fae5;">
                        <div>
                            <h4>üìä Export Data Transaksi (CSV)</h4>
                            <p style="font-size: 13px; color: var(--color-text-light); margin-bottom: var(--spacing-8);">Download semua data transaksi ke file CSV.</p>
                            <button class="btn btn-secondary" onclick="exportTransactionsToCSV()">üì• Export Transaksi</button>
                        </div>
                        <hr style="border: 0; border-top: 1px solid #d1fae5;">
                        <div>
                            <h4>üíæ Backup Database (Download)</h4>
                            <p style="font-size: 13px; color: var(--color-text-light); margin-bottom: var(--spacing-8);">Download semua data ke file JSON.</p>
                            <button class="btn btn-primary" onclick="exportData()">‚¨áÔ∏è Download Backup (.json)</button>
                        </div>
                        <hr style="border: 0; border-top: 1px solid #d1fae5;">
                        <div>
                            <h4>‚òÅÔ∏è Restore Database (Upload)</h4>
                            <p style="font-size: 13px; color: var(--color-text-light); margin-bottom: var(--spacing-8);">Upload file backup JSON.</p>
                            <input type="file" id="importFile" accept=".json" style="margin-bottom: var(--spacing-8);">
                            <button class="btn btn-warning" onclick="importData()">‚¨ÜÔ∏è Upload & Restore Data</button>
                        </div>
                        <hr style="border: 0; border-top: 1px solid #d1fae5;">
                        <div>
                            <h4>‚ö†Ô∏è Zona Bahaya</h4>
                            <p style="font-size: 13px; color: var(--color-text-light); margin-bottom: var(--spacing-8);">Hapus semua data dan kembali ke data contoh.</p>
                            <button class="btn btn-danger" onclick="resetData()">üóëÔ∏è Reset Semua Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Produk -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productModalTitle">Tambah Produk</h2>
                <button class="close-btn" onclick="closeModal('productModal')">&times;</button>
            </div>
            <form onsubmit="addProduct(event)">
                <div class="form-group">
                    <label>Nama Produk</label>
                    <input type="text" id="productName" required>
                </div>
                
                <div class="form-group">
                    <label>Poin Patokan (Per Satuan)</label>
                    <input type="number" id="productPoint" step="0.01" readonly style="background: #f3f4f6; color: #6b7280;">
                </div>

                <div class="form-group">
                    <label>Jumlah Pembelian Produk (Stok)</label>
                    <input type="number" id="productPembelian" min="0" required>
                    <small style="color: var(--color-text-light); display: block; margin-top: 4px;">Jumlah dibeli dari perusahaan</small>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Simpan Produk</button>
            </form>
        </div>
    </div>

    <!-- Modal Member -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="memberModalTitle">Tambah Member Baru</h2>
                <button class="close-btn" onclick="closeModal('memberModal')">&times;</button>
            </div>
            <form onsubmit="saveMember(event)">
                <input type="hidden" id="memberEditMode" value="false">
                <input type="hidden" id="memberOriginalId" value="">
                <div class="form-row">
                    <div class="form-group">
                        <label>ID Member <span style="color: var(--color-error);">*</span></label>
                        <input type="text" id="memberId" required placeholder="Contoh: M001">
                    </div>
                    <div class="form-group">
                        <label>Nama Member <span style="color: var(--color-error);">*</span></label>
                        <input type="text" id="memberName" required placeholder="Nama lengkap">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Upline</label>
                        <select id="memberUpline">
                            <option value="">-- Tidak Ada --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Koordinat</label>
                        <input type="text" id="memberKoordinat" placeholder="Contoh: -6.2088, 106.8456">
                    </div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="memberStatus">
                        <option value="aktif">Aktif</option>
                        <option value="tidak aktif">Tidak Aktif</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">üíæ Simpan Member</button>
            </form>
        </div>
    </div>

    <!-- Modal Transaksi -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Input Penjualan ke Member</h2>
                <button class="close-btn" onclick="closeModal('transactionModal')">&times;</button>
            </div>
            <form onsubmit="addTransaction(event)">
                <div class="form-group">
                    <label>Tanggal Transaksi</label>
                    <input type="date" id="transactionDate" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Member Pembeli</label>
                        <select id="transactionMember" required onchange="updateTransactionPreview()">
                            <option value="">-- Pilih Member --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Produk</label>
                        <select id="transactionProduct" required onchange="updateTransactionPreview()">
                            <option value="">-- Pilih Produk --</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Jumlah Jual</label>
                    <input type="number" id="transactionQty" value="1" min="1" required onchange="updateTransactionPreview()">
                </div>
                
                <div class="card" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 16px; margin-bottom: 16px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px;">
                        <span style="color: #64748b;">Stok Tersedia:</span>
                        <strong id="stockAvailableDisplay">-</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 14px;">
                        <span style="color: #64748b;">Poin Member:</span>
                        <strong id="transactionPoints" style="color: var(--color-primary);">0</strong>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Simpan Transaksi</button>
            </form>
        </div>
    </div>

    <script>
        const app = {
            products: [],
            members: [],
            transactions: [],
            STORAGE_KEY: 'stokis_system_data_v24_print_final',
            
            init() {
                this.loadData();
                this.setupEventListeners();
                this.render();
                const dashboard = document.getElementById('dashboard');
                if (dashboard) {
                    dashboard.classList.add('active');
                    dashboard.style.display = 'block';
                }
            },

            loadData() {
                const storedData = localStorage.getItem(this.STORAGE_KEY);
                if (storedData) {
                    try {
                        const data = JSON.parse(storedData);
                        let isDataValid = true;
                        if(data.products && data.products.length > 0) {
                            if(data.products[0].pembelian === undefined) {
                                isDataValid = false; 
                                console.log("Data format lama terdeteksi. Mereset data...");
                            }
                        }

                        if (isDataValid) {
                            this.products = data.products || [];
                            this.members = data.members || [];
                            this.transactions = data.transactions || [];
                        } else {
                            this.loadSampleData();
                        }
                    } catch (e) {
                        console.error('Gagal memuat data.', e);
                        this.loadSampleData();
                    }
                } else {
                    this.loadSampleData();
                }
            },

            saveData() {
                const data = {
                    products: this.products,
                    members: this.members,
                    transactions: this.transactions
                };
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
            },

            resetData() {
                if(confirm('Apakah Anda yakin ingin menghapus SEMUA data?')) {
                    localStorage.removeItem(this.STORAGE_KEY);
                    this.loadData(); 
                    this.render();
                    alert('Sistem di-reset.');
                }
            },

            loadSampleData() {
                const originalProductList = [
                    { name: 'Pendan Wulung', point: 7.00 },
                    { name: 'Pheromone', point: 0.05 },
                    { name: 'A Powder', point: 0.07 },
                    { name: 'B Powder', point: 0.07 },
                    { name: 'C Powder', point: 0.07 },
                    { name: 'A Kapsul', point: 0.10 },
                    { name: 'B Kapsul', point: 0.10 },
                    { name: 'C Kapsul', point: 0.10 },
                    { name: 'GM Max', point: 0.10 },
                    { name: 'Madu GM', point: 0.10 },
                    { name: 'Teh BMT', point: 0.02 },
                    { name: 'Teh Celup GM', point: 0.08 },
                    { name: 'Godogan', point: 0.08 },
                    { name: 'HB Core', point: 0.06 },
                    { name: 'HXA GM Dus', point: 0.13 },
                    { name: 'Magic Ring', point: 0.05 },
                    { name: 'GM Oil Besar', point: 0.07 },
                    { name: 'GMS2', point: 0.10 },
                    { name: 'RPGM', point: 0.05 },
                    { name: 'Spray', point: 0.02 },
                    { name: 'Gurah THT', point: 0.04 },
                    { name: 'GM Mustika', point: 0.08 },
                    { name: 'GM Fresh', point: 0.02 },
                    { name: 'Pendan Hitam 3D', point: 0.50 },
                    { name: 'New GM Peling', point: 0.05 },
                    { name: 'GM Pace', point: 0.10 },
                    { name: 'Spoon Kuningan', point: 0.08 },
                    { name: 'Vitamax', point: 0.02 },
                    { name: 'GM SKINCARE', point: 0.30 },
                    { name: 'Pheromone Black Series', point: 0.06 }
                ];

                this.products = originalProductList.map(p => {
                    return {
                        code: 'PROD_' + Date.now() + '_' + p.name.replace(/\s/g, ''),
                        name: p.name,
                        point: p.point,
                        pembelian: 0
                    };
                });

                this.members = [
                    { id: 'M001', name: 'Adi Kusumah', upline: null, koordinat: '', status: 'aktif', totalPoints: 0 },
                    { id: 'M002', name: 'Budi Santoso', upline: 'M001', koordinat: 'Bandung', status: 'aktif', totalPoints: 0 },
                    { id: 'M003', name: 'Citra Dewi', upline: 'M001', koordinat: 'Surabaya', status: 'aktif', totalPoints: 0 },
                    { id: 'M004', name: 'Doni Hartono', upline: 'M002', koordinat: 'Medan', status: 'tidak aktif', totalPoints: 0 }
                ];

                this.transactions = [];
            },

            setupEventListeners() {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        const tabName = e.target.dataset.tab;
                        const target = document.getElementById(tabName);

                        document.querySelectorAll('.tab-content').forEach(t => {
                            t.classList.remove('active');
                            t.style.display = 'none'; 
                        });

                        if(target) {
                            target.classList.add('active');
                            target.style.display = 'block'; 
                        }

                        if (tabName === 'points') {
                            this.renderPoints(); 
                        } else if (tabName === 'reports') {
                            toggleReportSection('overview');
                        }
                    });
                });
            },
            render() {
                this.renderDashboard();
                this.renderProducts();
                this.renderMembers();
                this.renderTransactions();
                this.updateModals();
                
                const pointsTab = document.getElementById('points');
                if (pointsTab && pointsTab.style.display === 'block') {
                    this.renderPoints();
                }
            },

            renderDashboard() {
                document.getElementById('total-members').textContent = this.members.length;
                document.getElementById('total-products').textContent = this.products.length;
                document.getElementById('total-transactions').textContent = this.transactions.length;

                const totalPoints = this.transactions.reduce((sum, t) => {
                    const product = this.products.find(p => p.code === t.productCode);
                    if(product) return sum + (product.point * t.qty);
                    return sum;
                }, 0);
                
                document.getElementById('total-points').textContent = totalPoints.toFixed(2);

                const tbody = document.querySelector('#recent-transactions tbody');
                tbody.innerHTML = '';
                if (this.transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9ca3af; padding: 24px;">Belum ada data</td></tr>';
                } else {
                    this.transactions.slice(-5).reverse().forEach(t => {
                        const member = this.members.find(m => m.id === t.memberId);
                        const product = this.products.find(p => p.code === t.productCode);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${t.date}</td>
                            <td>${member?.name || 'Unknown'}</td>
                            <td>${product?.name || 'Unknown'}</td>
                            <td class="text-right">${t.qty}</td>
                            <td class="text-right font-mono" style="color: var(--color-success); font-weight: 700;">${t.totalPoints.toFixed(2)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            },

            renderProducts() {
                const tbody = document.querySelector('#products-table tbody');
                tbody.innerHTML = '';
                
                this.products.forEach(p => {
                    const totalPoint = parseFloat(p.point) * parseInt(p.pembelian || 0);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${p.name}</strong></td>
                        <td><span class="badge badge-blue">${parseFloat(p.point).toFixed(2)}</span></td>
                        <td>
                            <input type="number" value="${p.pembelian}" min="0" onchange="updateProductStock('${p.code}', this.value)">
                        </td>
                        <td id="total-point-${p.code}" class="text-right font-mono" style="color: var(--color-primary); font-weight: 600;">${totalPoint.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="openEditProductModal('${p.code}')">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-secondary" style="color: var(--color-error); border: 1px solid #fecaca;" onclick="app.deleteProduct('${p.code}')">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            renderMembers() {
                const tbody = document.querySelector('#members-table tbody');
                tbody.innerHTML = '';
                this.members.forEach(m => {
                    const uplineName = this.members.find(u => u.id === m.upline)?.name || '-';
                    const statusClass = m.status === 'aktif' ? 'badge-success' : 'badge-inactive';
                    const statusText = m.status === 'aktif' ? 'Aktif' : 'Tidak Aktif';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${m.id}</strong></td>
                        <td>${m.name}</td>
                        <td>${uplineName}</td>
                        <td><span class="badge badge-blue">${m.koordinat || '-'}</span></td>
                        <td class="text-right font-mono" style="color: var(--color-primary); font-weight: 600;">${m.totalPoints.toFixed(2)}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="openEditMemberModal('${m.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-secondary" style="color: var(--color-error); border: 1px solid #fecaca;" onclick="app.deleteMember('${m.id}')">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            renderTransactions() {
                const tbody = document.querySelector('#transactions-table tbody');
                tbody.innerHTML = '';
                this.transactions.forEach((t, idx) => {
                    const member = this.members.find(m => m.id === t.memberId);
                    const product = this.products.find(p => p.code === t.productCode);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${idx + 1}</td>
                        <td>${t.date || '-'}</td>
                        <td>${member?.name || 'Unknown'}</td>
                        <td>${product?.name || 'Unknown'}</td>
                        <td class="text-right">${t.qty}</td>
                        <td class="text-right font-mono" style="color: var(--color-success); font-weight: 600;">${t.totalPoints.toFixed(2)}</td>
                        <td class="no-print">
                            <button class="btn btn-small btn-secondary" style="color: var(--color-error);" onclick="deleteTransaction(${idx})">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            renderPoints() {
                const tbody = document.querySelector('#points-table tbody');
                tbody.innerHTML = '';

                this.members.forEach(member => {
                    const points = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
                    
                    this.transactions.forEach(t => {
                        const product = this.products.find(p => p.code === t.productCode);
                        if (!product) return;

                        // Tentukan Skema Distribusi
                        const isPendan = product.name.toUpperCase().includes('PENDAN');
                        const levels = isPendan ? 6 : 3;
                        
                        // Ambil Total Poin Transaksi
                        const totalProductPoints = parseFloat(product.point) * t.qty;

                        // Direct Level 0 (Self)
                        if (t.memberId === member.id) {
                            points[0] += totalProductPoints * 0.7; 
                        }

                        const memberHierarchy = this.getMemberHierarchy(t.memberId);
                        const levelIndex = memberHierarchy.indexOf(member.id);
                        
                        // Distribusi Upline
                        if (levelIndex > 0 && levelIndex < levels) {
                            let factor = 0;
                            if (isPendan) {
                                if (levelIndex === 1) factor = 0.1;
                                else if (levelIndex === 2) factor = 0.08;
                                else if (levelIndex === 3) factor = 0.06;
                                else if (levelIndex === 4) factor = 0.04;
                                else if (levelIndex === 5) factor = 0.02;
                            } else {
                                if (levelIndex === 1) factor = 0.2;
                                else if (levelIndex === 2) factor = 0.1;
                            }
                            points[levelIndex] += totalProductPoints * factor;
                        }
                    });

                    const total = Object.values(points).reduce((a, b) => a + b, 0);
                    
                    // Tampilkan baris
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${member.name}</strong></td>
                        <td class="level-0">${points[0].toFixed(2)}</td>
                        <td class="level-1">${points[1].toFixed(2)}</td>
                        <td class="level-2">${points[2].toFixed(2)}</td>
                        <td class="level-3">${points[3].toFixed(2)}</td>
                        <td class="level-4">${points[4].toFixed(2)}</td>
                        <td class="level-5">${points[5].toFixed(2)}</td>
                        <td style="font-weight: 700; color: var(--color-primary);">${total.toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                });

                if (tbody.innerHTML === '') {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999;">Belum ada poin</td></tr>';
                }
            },

            getMemberHierarchy(memberId) {
                const hierarchy = [memberId];
                let current = memberId;
                
                while (current) {
                    const member = this.members.find(m => m.id === current);
                    if (member && member.upline) {
                        hierarchy.push(member.upline);
                        current = member.upline;
                    } else {
                        break;
                    }
                }
                
                return hierarchy;
            },
            updateModals() {
                const memberSelect = document.getElementById('transactionMember');
                const uplineSelect = document.getElementById('memberUpline');
                const productSelect = document.getElementById('transactionProduct');

                memberSelect.innerHTML = '<option value="">-- Pilih Member --</option>';
                uplineSelect.innerHTML = '<option value="">-- Tidak Ada --</option>';
                productSelect.innerHTML = '<option value="">-- Pilih Produk --</option>';

                this.members.forEach(m => {
                    memberSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                    uplineSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                });

                this.products.forEach(p => {
                    const stokInfo = ` (Stok: ${p.pembelian})`;
                    productSelect.innerHTML += `<option value="${p.code}">${p.name} ${stokInfo}</option>`;
                });
            },

            deleteMember(id) {
                if (confirm(`Hapus member ${id}?`)) {
                    this.members = this.members.filter(m => m.id !== id);
                    this.saveData(); 
                    this.render();
                }
            },

            deleteProduct(code) {
                if (confirm(`Hapus produk ${code}?`)) {
                    this.products = this.products.filter(p => p.code !== code);
                    this.saveData();
                    this.render();
                }
            }
        };

        // === LOGIKA SUPPORT ===
        function openAddProductModal() {
            document.getElementById('productModalTitle').innerText = 'Tambah Produk';
            document.querySelector('#productModal form').reset();
            document.getElementById('productModal').classList.add('active');
        }

        function openEditProductModal(code) {
            const product = app.products.find(p => p.code === code);
            if (!product) return;

            document.getElementById('productModalTitle').innerText = 'Edit Produk';
            
            document.getElementById('productName').value = product.name;
            document.getElementById('productPoint').value = product.point;
            document.getElementById('productPembelian').value = product.pembelian;

            document.getElementById('productModal').classList.add('active');
        }

        function addProduct(e) {
            e.preventDefault();
            
            const productData = {
                code: 'PROD_' + Date.now() + '_' + document.getElementById('productName').value.replace(/\s/g, ''),
                name: document.getElementById('productName').value,
                point: parseFloat(document.getElementById('productPoint').value),
                pembelian: parseInt(document.getElementById('productPembelian').value)
            };

            app.products.push(productData);
            app.saveData();
            closeModal('productModal');
            app.render();
        }

        function updateProductStock(code, newStock) {
            const product = app.products.find(p => p.code === code);
            if (product) {
                if (newStock < 0) { 
                    alert('Stok tidak bisa negatif!'); 
                    const inputElement = event.target;
                    inputElement.value = product.pembelian;
                    return; 
                }
                
                product.pembelian = parseInt(newStock);
                const newTotalPoint = parseFloat(product.point) * parseInt(product.pembelian);
                
                app.saveData();
                
                const pointCell = document.getElementById(`total-point-${code}`);
                if (pointCell) {
                    pointCell.innerText = newTotalPoint.toFixed(2);
                }
                
                const txProdSelect = document.getElementById('transactionProduct');
                if (txProdSelect) updateSelectOption(txProdSelect);
            }
        }

        function updateSelectOption(selectElement) {
            const currentVal = selectElement.value;
            selectElement.innerHTML = '<option value="">-- Pilih Produk --</option>';
            app.products.forEach(p => {
                const stokInfo = ` (Stok: ${p.pembelian})`;
                selectElement.innerHTML += `<option value="${p.code}">${p.name} ${stokInfo}</option>`;
            });
            selectElement.value = currentVal;
        }

        // === LOGIKA MEMBER ===
        function openAddMemberModal() {
            document.getElementById('memberModalTitle').textContent = 'Tambah Member Baru';
            document.getElementById('memberEditMode').value = 'false';
            document.getElementById('memberOriginalId').value = '';
            const nextId = 'M' + (app.members.length + 1).toString().padStart(3, '0');
            document.getElementById('memberId').value = nextId;
            document.getElementById('memberName').value = '';
            document.getElementById('memberUpline').value = '';
            document.getElementById('memberKoordinat').value = '';
            document.getElementById('memberStatus').value = 'aktif';
            document.getElementById('memberModal').classList.add('active');
        }

        function openEditMemberModal(memberId) {
            const member = app.members.find(m => m.id === memberId);
            if (!member) return;

            document.getElementById('memberModalTitle').textContent = 'Edit Member';
            document.getElementById('memberEditMode').value = 'true';
            document.getElementById('memberOriginalId').value = memberId;
            
            document.getElementById('memberId').value = member.id;
            document.getElementById('memberName').value = member.name;
            document.getElementById('memberUpline').value = member.upline || '';
            document.getElementById('memberKoordinat').value = member.koordinat || '';
            document.getElementById('memberStatus').value = member.status || 'aktif';

            document.getElementById('memberModal').classList.add('active');
        }

        function saveMember(e) {
            e.preventDefault();
            const isEditMode = document.getElementById('memberEditMode').value === 'true';
            const originalId = document.getElementById('memberOriginalId').value;
            const newId = document.getElementById('memberId').value.trim();
            const name = document.getElementById('memberName').value.trim();
            const upline = document.getElementById('memberUpline').value || null;
            const koordinat = document.getElementById('memberKoordinat').value.trim();
            const status = document.getElementById('memberStatus').value;

            if (!newId) { alert('ID Member tidak boleh kosong!'); return; }

            if (isEditMode) {
                const member = app.members.find(m => m.id === originalId);
                if (!member) return;

                if (newId !== originalId && app.members.find(m => m.id === newId)) {
                    alert(`ID "${newId}" sudah digunakan!`); return;
                }

                if (newId !== originalId) {
                    app.members.forEach(m => { if (m.upline === originalId) m.upline = newId; });
                    app.transactions.forEach(t => { if (t.memberId === originalId) t.memberId = newId; });
                }

                member.id = newId; member.name = name; member.upline = upline;
                member.koordinat = koordinat; member.status = status;
            } else {
                if (app.members.find(m => m.id === newId)) {
                    alert(`ID "${newId}" sudah terdaftar!`); return;
                }

                app.members.push({
                    id: newId, name: name, upline: upline,
                    koordinat: koordinat, status: status, totalPoints: 0
                });
            }

            app.saveData(); closeModal('memberModal'); app.render();
        }

        // === LOGIKA TRANSAKSI ===
        function openAddTransactionModal() {
            document.getElementById('transactionDate').valueAsDate = new Date();
            document.getElementById('transactionModal').classList.add('active');
            document.getElementById('transactionMember').value = "";
            document.getElementById('transactionProduct').value = "";
            document.getElementById('transactionQty').value = "1";
            updateTransactionPreview();
        }

        function updateTransactionPreview() {
            const memberId = document.getElementById('transactionMember').value;
            const productCode = document.getElementById('transactionProduct').value;
            const qty = parseInt(document.getElementById('transactionQty').value) || 1;
            
            const member = app.members.find(m => m.id === memberId);
            const product = app.products.find(p => p.code === productCode);

            if (member && product) {
                const totalPoints = parseFloat(product.point) * qty;
                document.getElementById('stockAvailableDisplay').textContent = product.pembelian;
                document.getElementById('transactionPoints').textContent = totalPoints.toFixed(2);
            } else {
                document.getElementById('stockAvailableDisplay').textContent = '-';
                document.getElementById('transactionPoints').textContent = '-';
            }
        }

        function addTransaction(e) {
            e.preventDefault();
            const memberId = document.getElementById('transactionMember').value;
            const productCode = document.getElementById('transactionProduct').value;
            const qty = parseInt(document.getElementById('transactionQty').value);
            const member = app.members.find(m => m.id === memberId);
            const product = app.products.find(p => p.code === productCode);

            if(!member || !product) return;

            if (product.pembelian < qty) {
                alert(`Stok produk ${product.name} tidak mencukup! Stok: ${product.pembelian}, Diminta: ${qty}`);
                return;
            }

            const dateInput = document.getElementById('transactionDate').value;
            const dateObj = new Date(dateInput);
            const dateFormatted = dateObj.toLocaleDateString('id-ID');

            const totalPoints = parseFloat(product.point) * qty;

            app.transactions.push({
                memberId, productCode, qty, totalPoints, date: dateFormatted
            });

            product.pembelian -= qty;
            member.totalPoints += totalPoints;

            app.saveData(); 
            closeModal('transactionModal');
            app.render();
        }

        function deleteTransaction(idx) {
            const transaction = app.transactions[idx];
            if (!transaction) return;

            const member = app.members.find(m => m.id === transaction.memberId);
            const product = app.products.find(p => p.code === transaction.productCode);

            if (confirm(`Hapus transaksi ini? Stok akan dikembalikan.`)) {
                if(product) {
                    product.pembelian += transaction.qty;
                }
                if (member) {
                    member.totalPoints -= transaction.totalPoints;
                }

                app.transactions.splice(idx, 1);
                app.saveData(); 
                app.render();
            }
        }

        // === LOGIKA UPLINE SUPPORT ===
        function getMemberHierarchy(memberId) {
            const hierarchy = [memberId];
            let current = memberId;
            
            while (current) {
                const member = app.members.find(m => m.id === current);
                if (member && member.upline) {
                    hierarchy.push(member.upline);
                    current = member.upline;
                } else {
                    break;
                }
            }
            
            return hierarchy;
        }

        // === LOGIKA LAPORAN ===
        function toggleReportSection(id) {
            document.querySelectorAll('.report-body').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.report-accordion').forEach(el => el.classList.remove('active'));

            const target = document.getElementById(id);
            const parent = document.getElementById('acc-' + id);
            
            target.classList.add('active');
            parent.classList.add('active');

            if(id === 'overview') renderOverviewReport();
            else if(id === 'ranking') renderRankingTable();
        }

        // === PERBAIKAN CETAK PEMISAHAN HALAMAN (TERPISAH) ===
        function printPage(pageId) {
            // Bersihkan kelas cetak sebelumnya agar tidak bentrok
            document.body.classList.remove('printing-transactions');
            document.body.classList.remove('printing-points');

            // Tambahkan kelas sesuai halaman yang diprint
            if (pageId === 'transactions') {
                document.body.classList.add('printing-transactions');
            } else if (pageId === 'points') {
                document.body.classList.add('printing-points');
            }

            window.print();

            // Hapus kelas setelah dialog print selesai (perkiraan aman)
            setTimeout(() => {
                document.body.classList.remove('printing-transactions');
                document.body.classList.remove('printing-points');
            }, 1000);
        }

        function printReport() {
            // Fungsi print untuk bagian Reports (sudah ada)
            document.body.classList.remove('printing-transactions');
            document.body.classList.remove('printing-points');
            window.print();
            setTimeout(() => {
                document.body.classList.remove('printing-transactions');
                document.body.classList.remove('printing-points');
            }, 1000);
        }

        function exportData() {
            const dataStr = JSON.stringify({
                products: app.products,
                members: app.members,
                transactions: app.transactions,
                exportedAt: new Date().toISOString()
            }, null, 2);
            
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `stokis_backup_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            if (!file) { alert('Silakan pilih file .json terlebih dahulu!'); return; }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data.products) || !Array.isArray(data.members) || !Array.isArray(data.transactions)) {
                        throw new Error('Format file tidak valid!');
                    }

                    if(confirm('Data akan ditimpa. Lanjutkan?')) {
                        app.products = data.products;
                        app.members = data.members;
                        app.transactions = data.transactions;
                        
                        app.saveData();
                        app.render();
                        alert('Data berhasil dipulihkan!');
                        fileInput.value = ''; 
                    }
                } catch (err) {
                    alert('Gagal membaca file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function renderOverviewReport() {
            const tbody = document.querySelector('#report-table tbody');
            tbody.innerHTML = '';
            
            let totalBeliQty = 0;
            let totalBeliPoint = 0;
            let totalJualQty = 0;
            let totalJualPoint = 0;

            app.products.forEach(product => {
                const qtyBeli = product.pembelian;
                const poinBeli = qtyBeli * parseFloat(product.point);

                const txs = app.transactions.filter(t => t.productCode === product.code);
                const qtyJual = txs.reduce((sum, t) => sum + t.qty, 0);
                const poinJual = qtyJual * parseFloat(product.point);

                if (qtyBeli > 0 || qtyJual > 0) {
                    totalBeliQty += qtyBeli;
                    totalBeliPoint += poinBeli;
                    totalJualQty += qtyJual;
                    totalJualPoint += poinJual;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="text-align: center;">${parseFloat(product.point).toFixed(2)}</td>
                        <td style="text-align: right; font-weight: 600;">${qtyBeli}</td>
                        <td style="text-align: right; font-weight: 600;">${poinBeli.toFixed(2)}</td>
                        <td style="text-align: right; color: var(--color-success); font-weight: 700;">${qtyJual}</td>
                        <td style="text-align: right; color: var(--color-success); font-weight: 700;">${poinJual.toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                }
            });
            
            document.getElementById('report-sum-beli').textContent = totalBeliQty;
            document.getElementById('report-sum-point-beli').textContent = totalBeliPoint.toFixed(2);
            document.getElementById('report-sum-jual').textContent = totalJualQty;
            document.getElementById('report-sum-point-jual').textContent = totalJualPoint.toFixed(2);

            if (tbody.innerHTML === '') {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9ca3af; padding: 20px;">Belum ada data</td></tr>';
                document.getElementById('report-sum-beli').textContent = 0;
                document.getElementById('report-sum-point-beli').textContent = "0.00";
                document.getElementById('report-sum-jual').textContent = 0;
                document.getElementById('report-sum-point-jual').textContent = "0.00";
            }
        }

        function renderRankingTable() {
            const tbody = document.querySelector('#ranking-table tbody');
            tbody.innerHTML = '';

            const memberPoints = {};
            const memberStats = {};

            app.members.forEach(m => {
                memberPoints[m.id] = 0;
                memberStats[m.id] = {
                    name: m.name,
                    upline: app.members.find(u => u.id === m.upline)?.name || '-'
                };
            });

            app.transactions.forEach(t => {
                const product = app.products.find(p => p.code === t.productCode);
                if (!product) return;

                const isPendan = product.name.toUpperCase().includes('PENDAN');
                const levels = isPendan ? 6 : 3;
                const totalProductPoints = parseFloat(product.point) * t.qty;

                if (memberPoints[t.memberId] !== undefined) {
                    memberPoints[t.memberId] += totalProductPoints * 0.7; // Level 0
                }

                const hierarchy = getMemberHierarchy(t.memberId);
                hierarchy.forEach((mId, levelIdx) => {
                    if (levelIdx > 0 && levelIdx < levels && memberPoints[mId] !== undefined) {
                        let factor = 0;
                        if (isPendan) {
                            if (levelIdx === 1) factor = 0.1; else if (levelIdx === 2) factor = 0.08;
                            else if (levelIdx === 3) factor = 0.06; else if (levelIdx === 4) factor = 0.04;
                            else if (levelIdx === 5) factor = 0.02;
                        } else {
                            if (levelIdx === 1) factor = 0.2; else if (levelIdx === 2) factor = 0.1;
                        }
                        memberPoints[mId] += totalProductPoints * factor;
                    }
                });
            });

            const ranking = Object.entries(memberPoints)
                .map(([memberId, points]) => ({
                    id: memberId,
                    points,
                    ...memberStats[memberId]
                }))
                .filter(item => item.points > 0)
                .sort((a, b) => b.points - a.points);

            if (ranking.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Belum ada point</td></tr>';
                return;
            }

            ranking.forEach((item, idx) => {
                const medalEmoji = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : '‚Ä¢';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 700; font-size: 16px; text-align: center;">
                        ${medalEmoji} #${idx + 1}
                    </td>
                    <td style="text-align: center;"><strong>${item.id}</strong></td>
                    <td>${item.name}</td>
                    <td style="font-weight: 700; color: var(--color-primary); font-size: 16px; text-align: center;">
                        ${item.points.toFixed(2)}
                    </td>
                    <td>${item.upline}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // === UTILS ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }
        function closeSidebarMobile() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        function checkLogin(e) {
            e.preventDefault();
            const u = document.getElementById('loginUsername').value;
            const p = document.getElementById('loginPassword').value;
            if (u === 'GMRJ' && p === '333100') {
                document.getElementById('login-screen').style.display = 'none';
                document.querySelector('.container').style.display = 'grid';
                app.init();
            } else {
                alert('Username atau Password Salah!');
            }
        }

        // PERBAIKAN EKSPOR MEMBER (ID, NAMA, UPLINE, KOORDINAT SAJA)
        function exportMembersToCSV() {
            if (app.members.length === 0) { alert('Tidak ada data member.'); return; }
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM untuk Excel
            csvContent += "ID,Nama,Upline,Koordinat\n";

            app.members.forEach(m => {
                const uplineName = app.members.find(u => u.id === m.upline)?.name || '';
                
                // Urutan sesuai permintaan: ID, Nama, Upline, Koordinat
                const row = [
                    m.id,
                    m.name,
                    uplineName,
                    m.koordinat || ''
                ];
                csvContent += row.map(item => `"${item}"`).join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "data_member_stokis.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // PERBAIKAN EKSPOR TRANSAKSI (FORMAT TEMPLATE SEDERHANA)
        function exportTransactionsToCSV() {
            if (app.transactions.length === 0) { alert('Tidak ada data transaksi.'); return; }
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header: No, Tanggal, Member, Produk, Jumlah
            csvContent += "No,Tanggal,Member,Produk,Jumlah\n";

            app.transactions.forEach((t, index) => {
                const m = app.members.find(mem => mem.id === t.memberId);
                const p = app.products.find(prod => prod.code === t.productCode);
                const row = [
                    index +1,                           // No
                    t.date || "",                       // Tanggal
                    m ? m.name : "Unknown",             // Member
                    p ? p.name : "Unknown",             // Produk
                    t.qty                               // Jumlah
                ];
                csvContent += row.map(item => `"${item}"`).join(",") + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "transaksi_stokis.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // === FUNGSI EXPORT EXCEL TAMBAHAN ===
        function exportTransactionsToExcel() {
            if (app.transactions.length === 0) { alert('Tidak ada data transaksi.'); return; }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
            csvContent += "No,Tanggal,Member,Produk,Jml Jual,Total Poin\n";

            app.transactions.forEach((t, index) => {
                const m = app.members.find(mem => mem.id === t.memberId);
                const p = app.products.find(prod => prod.code === t.productCode);
                const row = [
                    index +1,
                    t.date,
                    m ? m.name : "Unknown",
                    p ? p.name : "Unknown",
                    t.qty,
                    t.totalPoints
                ];
                csvContent += row.map(item => `"${item}"`).join(",") + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Laporan_Transaksi_Excel.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportPointsToExcel() {
            if (app.members.length === 0) { alert('Tidak ada data member/poin.'); return; }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "Member,Poin Level 0,Poin Level 1,Poin Level 2,Poin Level 3,Poin Level 4,Poin Level 5,Total Poin\n";

            app.members.forEach(member => {
                const points = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
                
                // Hitung ulang poin agar sinkron
                app.transactions.forEach(t => {
                    const product = app.products.find(p => p.code === t.productCode);
                    if (!product) return;

                    const isPendan = product.name.toUpperCase().includes('PENDAN');
                    const levels = isPendan ? 6 : 3;
                    const totalProductPoints = parseFloat(product.point) * t.qty;

                    if (t.memberId === member.id) {
                        points[0] += totalProductPoints * 0.7; 
                    }

                    const memberHierarchy = app.getMemberHierarchy(t.memberId);
                    const levelIndex = memberHierarchy.indexOf(member.id);
                    
                    if (levelIndex > 0 && levelIndex < levels) {
                        let factor = 0;
                        if (isPendan) {
                            if (levelIndex === 1) factor = 0.1;
                            else if (levelIndex === 2) factor = 0.08;
                            else if (levelIndex === 3) factor = 0.06;
                            else if (levelIndex === 4) factor = 0.04;
                            else if (levelIndex === 5) factor = 0.02;
                        } else {
                            if (levelIndex === 1) factor = 0.2;
                            else if (levelIndex === 2) factor = 0.1;
                        }
                        points[levelIndex] += totalProductPoints * factor;
                    }
                });

                const total = Object.values(points).reduce((a, b) => a + b, 0);
                
                const row = [
                    member.name,
                    points[0].toFixed(2),
                    points[1].toFixed(2),
                    points[2].toFixed(2),
                    points[3].toFixed(2),
                    points[4].toFixed(2),
                    points[5].toFixed(2),
                    total.toFixed(2)
                ];
                csvContent += row.map(item => `"${item}"`).join(",") + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Laporan_Poin_Member_Excel.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.addEventListener('DOMContentLoaded', () => {});
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) { e.target.classList.remove('active'); }
            if (window.innerWidth <= 768 && !e.target.closest('.sidebar') && !e.target.closest('.mobile-menu-btn')) {
                document.querySelector('.sidebar').classList.remove('active');
            }
        });
    </script>
</body>
</html>